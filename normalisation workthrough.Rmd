---
title: "Normalisation Script Revisited"
author: "Peter Ditchfield"
date: "08/07/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## An RMarkdown work though of Erica's normalisation script

Erika's normalization calculation and data-quality checking	srcipt is widely used in RLAHA but it hasn't been maintained for a long time. Many people use it but I dont know exactly what it does and how it works. So this is a work through to see if I can understand it more fully. Code and text from Erica's script are in *italics* my comments are in **bold** text

##  Actions of each section.

*#Section 1 getting the data into the script*

*1. Put your runfile's location in the quotation marks" Change nothing else in line 15.*

*<- remove this comment if using lab basement computer -> *

*setwd("C:/Users/Sercon_1/Desktop") # Place csv file on desktop*

*setwd("~/Dropbox Oxford/Dropbox/dropbox AGRICURB/Runfiles/160812")*
 

 
 
 
```{r}
name <- read.csv("160812.csv", header=F)[, c(1:3, 5, 6,9:11)] # this is her line 15

runfile.id <- "160812"
```

**So this just reads selected columns of the raw .csv data file into a table called name without the headders and creates a variable called runfile.id which is the run number**

*Section 2. Assign RM1 and RM2 the same character string as in your spreadsheet*
*RM1.name <- "SEAL2" # <- the name of your RM1 exactly as it is in the spreadsheet*
*RM2.name <- "USGS40" # <- the name of your RM2 exactly as it is in the spreadsheet*

```{r}
# 2. Assign RM1 and RM2 the same character string as in your spreadsheet.
RM1.name <- "SEAL2" # <- the name of your RM1 exactly as it is in the spreadsheet
RM2.name <- "USGS40" # <- the name of your RM2 exactly as it is in the spreadsheet
```

**This assigns the refernce materials (RM1, RM2) to the  known value reference materials used in the run to enable the two point correction.**

*#3. For RM1 and RM2, give the true d15N values relative to AIR and stdev obtained from literature*
*RM1T.N <- 17.3	  #RM1 d15N mean*
*RM1Tsd.N <- 0.29		#RM1 d15N standard deviation*
*RM2T.N <- -4.52 	# RM2 d15N mean*
*RM2Tsd.N <- 0.06	#RM2 d15N standard deviation*

```{r}
# 3. For RM1 and RM2, give the true d15N values relative to AIR and stdev obtained from literature
RM1T.N <- 17.3	  #RM1 d15N mean
RM1Tsd.N <- 0.29		#RM1 d15N standard deviation
RM2T.N <- -4.52 	# RM2 d15N mean
RM2Tsd.N <- 0.06	#RM2 d15N standard deviation
```

**This puts the known nitrogen isotope values and standard variations of the reference materials into the named variables.**

*#4. For RM1 and RM2, give the true d13C values relative to VPDB and stdev obtained from literature*
*RM1T.C <- -13.3	# RM1 d13C mean*
*RM1Tsd.C <- 0.11		# RM1 d13C standard deviation*
*RM2T.C <- -26.39 	# RM2 d13C mean* 
*RM2Tsd.C <- 0.04	# RM2 d13C standard deviation*

```{r}
# 4. For RM1 and RM2, give the true d13C values relative to VPDB and stdev obtained from literature
RM1T.C <- -13.3	# RM1 d13C mean
RM1Tsd.C <- 0.11		# RM1 d13C standard deviation
RM2T.C <- -26.39 	# RM2 d13C mean 
RM2Tsd.C <- 0.04	# RM2 d13C standard deviation

```

**This does the same for the carbon isotope values of the reference materials.**

*# 	Don't forget to change C RMs below		   #*

**I am not sure what she meant by this comment**

**the next section is not numbered**

*#	Formatting columns from raw data file	   #*

*# sets up a vector of integers from 1 to the number of rows in the csv file*
*rownumber <- (1:nrow(name))*
*# puts the undriftcorrected data into the table name2. starting at row 9* 
*# and truncating the end statment and its row number at the end of the undrift    corrected section*
*name2 <- name[9:((rownumber[name[,1]=="Drift Corrected"])-2),]*

*#puts the driftcorrected data from 4 rows beyond the drift corrected statment* *#to the end of the file into a table called name3* 
*name3 <- name[((rownumber[name[,1]=="Drift Corrected"])+4):nrow(name),]*

```{r}
#	Formatting columns from raw data file	   #
#
# sets up a vector of integers from 1 to the number of rows in the csv file
rownumber <- (1:nrow(name))
# puts the undriftcorrected data into the table name2. starting at row 9 
# and truncating the end statment and its row number at the end of the undrift #corrected section
name2 <- name[9:((rownumber[name[,1]=="Drift Corrected"])-2),]

#puts the driftcorrected data from 4 rows beyond the drift corrected statment 
#to the end of the file into a table called name3 
name3 <- name[((rownumber[name[,1]=="Drift Corrected"])+4):nrow(name),]
```

**This chunk puts the undrift corrected data into a data frame called name2 and the drift corrected data into a df called name3. It uses the 'drift corrected' statement in the original file as a marker to know where to stop and start in each case**
**it also sets up a vector of integers the same length as the whole csv file**

*strReverse <- function(x)*
  *sapply(lapply(strsplit(x, NULL), rev), paste, collapse="")*
*runname <- runfile.id*      
*data <- data.frame(name2,  name3[,4:8], rep(runname, nrow(name2)), rep(0,* *nrow(name2)),rep(0, nrow(name2)),rep(0, nrow(name2)))*

```{r}
strReverse <- function(x)
  sapply(lapply(strsplit(x, NULL), rev), paste, collapse="")
runname <- runfile.id      
data <- data.frame(name2,  name3[,4:8], rep(runname, nrow(name2)), rep(0, nrow(name2)),rep(0, nrow(name2)),rep(0, nrow(name2)))
```

**This reads runfile.id i.e. the run number into a variable called runname** 
**then makes a new df called data which has collumns from the undrift corrected and the drift correct parts of the csv file. It also adds some extra columns with rep inculding the run bumber and three columns of zeros**

**I dont know what the strReverse function is doing. It is a function to reverse character strings see examples in the strspilt help page for details, but I dont know what it is doing here. The only thing that might be worth reversing is the run number which when reveresed would give the date of the run**

*# add colunm names to the data.frame (data)*
*names(data) <- c("Ps", "ID", "Wt", "NugR", "d15NR", "CugR",* *"d13CR", "d18OR", "Nugdc", "d15Ndc", "Cugdc", "d13Cdc",* *"d18Odc", "Runfile", "pcC", "pcN", "CN")*

```{r}
# add colunm names to the data.frame (data)
names(data) <- c("Ps", "ID", "Wt", "NugR", "d15NR", "CugR", "d13CR", "d18OR", "Nugdc", "d15Ndc", "Cugdc", "d13Cdc", "d18Odc", "Runfile", "pcC", "pcN", "CN")

```

**this adds names to the columns in the df data, note dc is drift corrected but many of the columns are as factors so**

*#make numeric things numeric*
*for (i in c(1, 3:13, 15:17)){data[,i] <-* *as.numeric(as.character(data[,i]))}*

```{r}
#make numeric things numeric
for (i in c(1, 3:13, 15:17)){data[,i] <- as.numeric(as.character(data[,i]))}
```
 
 **this makes the columns that need to numeric into numeric..but by itteration rather than selecting and using the as.numeric function..prosibly because as they are factors they might return the underlying factor integer value which would not be helpful**
 
 
 






